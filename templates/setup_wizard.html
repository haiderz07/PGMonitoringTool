{% extends "base.html" %}

{% block title %}Setup Wizard - PG-Monitor{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-4xl mx-auto">
        <!-- Progress Steps -->
        <div class="mb-8">
            <div class="flex items-center justify-center">
                <div class="flex items-center">
                    <div id="step1-indicator" class="flex items-center text-purple-600">
                        <div class="rounded-full h-12 w-12 flex items-center justify-center border-2 border-purple-600 bg-purple-600 text-white font-bold">
                            1
                        </div>
                        <div class="ml-3">
                            <p class="text-sm font-medium">Step 1</p>
                            <p class="text-xs text-gray-500">Create DB User</p>
                        </div>
                    </div>
                    <div class="w-24 h-1 bg-gray-300 mx-4"></div>
                    <div id="step2-indicator" class="flex items-center text-gray-400">
                        <div class="rounded-full h-12 w-12 flex items-center justify-center border-2 border-gray-300 bg-white font-bold">
                            2
                        </div>
                        <div class="ml-3">
                            <p class="text-sm font-medium">Step 2</p>
                            <p class="text-xs text-gray-500">Add Connection</p>
                        </div>
                    </div>
                    <div class="w-24 h-1 bg-gray-300 mx-4"></div>
                    <div id="step3-indicator" class="flex items-center text-gray-400">
                        <div class="rounded-full h-12 w-12 flex items-center justify-center border-2 border-gray-300 bg-white font-bold">
                            3
                        </div>
                        <div class="ml-3">
                            <p class="text-sm font-medium">Step 3</p>
                            <p class="text-xs text-gray-500">Test & Save</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 1: Create PostgreSQL User -->
        <div id="step1" class="bg-white rounded-lg shadow-xl p-8">
            <div class="text-center mb-6">
                <i class="fas fa-user-shield text-purple-600 text-5xl mb-4"></i>
                <h2 class="text-3xl font-bold text-gray-900">Step 1: Create PostgreSQL Monitoring User</h2>
                <p class="mt-2 text-gray-600">Follow these commands to create a secure read-only user for monitoring</p>
            </div>

            <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-6">
                <div class="flex">
                    <i class="fas fa-info-circle text-blue-400 mt-1 mr-3"></i>
                    <div>
                        <p class="text-sm text-blue-700">
                            <strong>Why do we need this?</strong><br>
                            PG-Monitor needs SELECT permission on system views to gather metrics safely without modifying your data.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Connection Details -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold mb-4 text-gray-800">
                    <i class="fas fa-terminal mr-2"></i>SQL Commands to Run
                </h3>
                
                <div class="space-y-4">
                    <!-- Command 1: Create User -->
                    <div class="bg-gray-900 rounded-lg p-4 relative">
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-green-400 text-xs font-mono">-- Step 1.1: Create monitoring user</span>
                            <button onclick="copyCommand('cmd1')" class="text-gray-400 hover:text-white">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        <pre id="cmd1" class="text-white font-mono text-sm overflow-x-auto">CREATE USER monitor_user_cli WITH PASSWORD 'your_secure_password_here';</pre>
                        <p class="text-gray-400 text-xs mt-2">‚ö†Ô∏è Replace 'your_secure_password_here' with a strong password</p>
                    </div>

                    <!-- Command 2: Grant Connect -->
                    <div class="bg-gray-900 rounded-lg p-4 relative">
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-green-400 text-xs font-mono">-- Step 1.2: Grant CONNECT permission</span>
                            <button onclick="copyCommand('cmd2')" class="text-gray-400 hover:text-white">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        <pre id="cmd2" class="text-white font-mono text-sm overflow-x-auto">GRANT CONNECT ON DATABASE your_database_name TO monitor_user_cli;</pre>
                        <p class="text-gray-400 text-xs mt-2">‚ö†Ô∏è Replace 'your_database_name' with your actual database name</p>
                    </div>

                    <!-- Command 3: Grant Usage on Schema -->
                    <div class="bg-gray-900 rounded-lg p-4 relative">
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-green-400 text-xs font-mono">-- Step 1.3: Grant schema usage</span>
                            <button onclick="copyCommand('cmd3')" class="text-gray-400 hover:text-white">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        <pre id="cmd3" class="text-white font-mono text-sm overflow-x-auto">GRANT USAGE ON SCHEMA public TO monitor_user_cli;</pre>
                    </div>

                    <!-- Command 4: Grant SELECT on Tables -->
                    <div class="bg-gray-900 rounded-lg p-4 relative">
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-green-400 text-xs font-mono">-- Step 1.4: Grant SELECT on all tables (read-only)</span>
                            <button onclick="copyCommand('cmd4')" class="text-gray-400 hover:text-white">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        <pre id="cmd4" class="text-white font-mono text-sm overflow-x-auto">GRANT SELECT ON ALL TABLES IN SCHEMA public TO monitor_user_cli;
GRANT SELECT ON ALL SEQUENCES IN SCHEMA public TO monitor_user_cli;</pre>
                    </div>

                    <!-- Command 5: Grant System View Access -->
                    <div class="bg-gray-900 rounded-lg p-4 relative">
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-green-400 text-xs font-mono">-- Step 1.5: Grant access to pg_stat views (for monitoring)</span>
                            <button onclick="copyCommand('cmd5')" class="text-gray-400 hover:text-white">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        <pre id="cmd5" class="text-white font-mono text-sm overflow-x-auto">-- PostgreSQL 10+: Use built-in monitoring role
GRANT pg_monitor TO monitor_user_cli;</pre>
                        <p class="text-gray-400 text-xs mt-2">üìå For PostgreSQL 9.6 and earlier, use alternative commands in the dropdown below</p>
                    </div>

                    <!-- Alternative for older PostgreSQL -->
                    <details class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                        <summary class="cursor-pointer font-semibold text-yellow-800">
                            <i class="fas fa-exclamation-triangle mr-2"></i>Alternative for PostgreSQL 9.6 and earlier
                        </summary>
                        <div class="mt-3 bg-gray-900 rounded p-3">
                            <pre class="text-white font-mono text-sm overflow-x-auto">-- For PostgreSQL < 10 (pg_monitor role doesn't exist)
GRANT SELECT ON pg_stat_database TO monitor_user_cli;
GRANT SELECT ON pg_stat_user_tables TO monitor_user_cli;
GRANT SELECT ON pg_stat_user_indexes TO monitor_user_cli;
GRANT SELECT ON pg_statio_user_tables TO monitor_user_cli;</pre>
                        </div>
                    </details>
                </div>
            </div>

            <!-- Permissions Summary -->
            <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
                <h4 class="font-semibold text-green-800 mb-2">
                    <i class="fas fa-shield-alt mr-2"></i>Permissions Summary
                </h4>
                <ul class="text-sm text-green-700 space-y-1">
                    <li><i class="fas fa-check mr-2"></i><strong>CONNECT:</strong> Connect to database</li>
                    <li><i class="fas fa-check mr-2"></i><strong>SELECT:</strong> Read-only access to tables (cannot modify data)</li>
                    <li><i class="fas fa-check mr-2"></i><strong>pg_monitor role:</strong> Access to system monitoring views</li>
                    <li class="mt-2"><i class="fas fa-lock mr-2 text-green-600"></i><strong>Security:</strong> This user CANNOT insert, update, or delete any data!</li>
                </ul>
            </div>

            <div class="flex justify-center mt-8">
                <button onclick="goToStep2()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-8 rounded-lg flex items-center">
                    I've Created the User - Next Step
                    <i class="fas fa-arrow-right ml-2"></i>
                </button>
            </div>
        </div>

        <!-- Step 2: Add Connection -->
        <div id="step2" class="bg-white rounded-lg shadow-xl p-8 hidden">
            <div class="text-center mb-6">
                <i class="fas fa-plug text-purple-600 text-5xl mb-4"></i>
                <h2 class="text-3xl font-bold text-gray-900">Step 2: Add Database Connection</h2>
                <p class="mt-2 text-gray-600">Enter your PostgreSQL connection details</p>
            </div>

            <form id="connectionForm" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Connection Name</label>
                        <input type="text" id="connName" required
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500"
                               placeholder="Production DB">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Host</label>
                        <input type="text" id="connHost" required
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500"
                               placeholder="localhost or server.postgres.database.azure.com">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Port</label>
                        <input type="number" id="connPort" value="5432" required
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Database</label>
                        <input type="text" id="connDatabase" required
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500"
                               placeholder="postgres">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Username</label>
                        <input type="text" id="connUsername" value="monitor_user_cli"
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Password</label>
                        <input type="password" id="connPassword" required
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500">
                    </div>
                </div>

                <div class="flex justify-between mt-8">
                    <button type="button" onclick="goToStep1()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-6 rounded-lg">
                        <i class="fas fa-arrow-left mr-2"></i>Back
                    </button>
                    <button type="button" onclick="goToStep3()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg">
                        Next - Test Connection
                        <i class="fas fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </form>
        </div>

        <!-- Step 3: Test & Save -->
        <div id="step3" class="bg-white rounded-lg shadow-xl p-8 hidden">
            <div class="text-center mb-6">
                <i class="fas fa-check-circle text-purple-600 text-5xl mb-4"></i>
                <h2 class="text-3xl font-bold text-gray-900">Step 3: Test & Save Connection</h2>
                <p class="mt-2 text-gray-600">Verify the connection works before saving</p>
            </div>

            <div id="testResult" class="mb-6"></div>

            <div class="flex justify-center space-x-4">
                <button type="button" onclick="goToStep2()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-6 rounded-lg">
                    <i class="fas fa-arrow-left mr-2"></i>Back
                </button>
                <button type="button" onclick="testConnection()" id="testBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg">
                    <i class="fas fa-vial mr-2"></i>Test Connection
                </button>
                <button type="button" onclick="saveConnection()" id="saveBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg hidden">
                    <i class="fas fa-save mr-2"></i>Save & Start Monitoring
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function copyCommand(id) {
    const text = document.getElementById(id).textContent;
    navigator.clipboard.writeText(text);
    alert('‚úÖ Command copied to clipboard!');
}

function goToStep1() {
    document.getElementById('step1').classList.remove('hidden');
    document.getElementById('step2').classList.add('hidden');
    document.getElementById('step3').classList.add('hidden');
    updateProgress(1);
}

function goToStep2() {
    document.getElementById('step1').classList.add('hidden');
    document.getElementById('step2').classList.remove('hidden');
    document.getElementById('step3').classList.add('hidden');
    updateProgress(2);
}

function goToStep3() {
    // Validate form
    const form = document.getElementById('connectionForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    document.getElementById('step1').classList.add('hidden');
    document.getElementById('step2').classList.add('hidden');
    document.getElementById('step3').classList.remove('hidden');
    updateProgress(3);
}

function updateProgress(step) {
    // Reset all
    for (let i = 1; i <= 3; i++) {
        const indicator = document.getElementById(`step${i}-indicator`);
        if (i < step) {
            indicator.classList.add('text-green-600');
            indicator.classList.remove('text-purple-600', 'text-gray-400');
            indicator.querySelector('div').classList.add('bg-green-600', 'border-green-600');
            indicator.querySelector('div').classList.remove('bg-purple-600', 'border-purple-600', 'bg-white', 'border-gray-300');
        } else if (i === step) {
            indicator.classList.add('text-purple-600');
            indicator.classList.remove('text-green-600', 'text-gray-400');
            indicator.querySelector('div').classList.add('bg-purple-600', 'border-purple-600');
            indicator.querySelector('div').classList.remove('bg-green-600', 'border-green-600', 'bg-white', 'border-gray-300');
        } else {
            indicator.classList.add('text-gray-400');
            indicator.classList.remove('text-green-600', 'text-purple-600');
            indicator.querySelector('div').classList.add('bg-white', 'border-gray-300');
            indicator.querySelector('div').classList.remove('bg-green-600', 'border-green-600', 'bg-purple-600', 'border-purple-600');
        }
    }
}

function testConnection() {
    const testBtn = document.getElementById('testBtn');
    const testResult = document.getElementById('testResult');
    
    testBtn.disabled = true;
    testBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Testing...';
    
    const data = {
        host: document.getElementById('connHost').value,
        port: document.getElementById('connPort').value,
        database: document.getElementById('connDatabase').value,
        username: document.getElementById('connUsername').value,
        password: document.getElementById('connPassword').value
    };
    
    fetch('/api/test-connection', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            testResult.innerHTML = `
                <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative">
                    <strong class="font-bold"><i class="fas fa-check-circle mr-2"></i>Connection Successful!</strong>
                    <p class="mt-2">PostgreSQL Version: ${result.version}</p>
                    <p>Connected as: ${result.current_user}</p>
                </div>
            `;
            document.getElementById('saveBtn').classList.remove('hidden');
        } else {
            testResult.innerHTML = `
                <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative">
                    <strong class="font-bold"><i class="fas fa-times-circle mr-2"></i>Connection Failed</strong>
                    <p class="mt-2">${result.message}</p>
                </div>
            `;
        }
    })
    .catch(error => {
        testResult.innerHTML = `
            <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative">
                <strong class="font-bold">Error</strong>
                <p class="mt-2">${error.message}</p>
            </div>
        `;
    })
    .finally(() => {
        testBtn.disabled = false;
        testBtn.innerHTML = '<i class="fas fa-vial mr-2"></i>Test Connection';
    });
}

function saveConnection() {
    const saveBtn = document.getElementById('saveBtn');
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';
    
    const data = {
        name: document.getElementById('connName').value,
        host: document.getElementById('connHost').value,
        port: document.getElementById('connPort').value,
        database: document.getElementById('connDatabase').value,
        username: document.getElementById('connUsername').value,
        password: document.getElementById('connPassword').value
    };
    
    fetch('/api/save-connection', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            window.location.href = result.redirect;
        } else {
            alert(result.message);
        }
    })
    .catch(error => {
        alert('Error: ' + error.message);
    })
    .finally(() => {
        saveBtn.disabled = false;
        saveBtn.innerHTML = '<i class="fas fa-save mr-2"></i>Save & Start Monitoring';
    });
}
</script>
{% endblock %}
